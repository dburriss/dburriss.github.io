<!DOCTYPE html>
<html><head><!-- META --><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Testing the Untestable</title><meta name="description" content="Testing after the fact testing hurts"><meta name="author" content="Devon Burriss"><link rel="canonical" href="https://devonburriss.me/testing-the-untestable/"><meta itemprop="datePublished" content="2015-01-27" id="date"><meta itemprop="dateModified" content="2015-01-27" id="mdate"><meta itemprop="headline" content="Testing the Untestable - Testing after the fact testing hurts"><meta itemprop="mainEntityOfPage" content="https://devonburriss.me/testing-the-untestable/"><meta name="headline" content="Testing the Untestable - Testing after the fact testing hurts"><link rel="icon" type="image/png" href="/img/favicon16.png" sizes="16x16"><link rel="icon" type="image/png" href="/img/favicon32.png" sizes="32x32"><meta itemprop="name" content="Testing the Untestable"><meta itemprop="description" content="Testing after the fact testing hurts"><meta itemprop="image" content="https://devonburriss.me/img/explore-590.jpg"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@DevonBurriss"><meta name="twitter:title" content="Testing the Untestable"><meta name="twitter:description" content="Testing after the fact testing hurts"><meta name="twitter:creator" content="@DevonBurriss"><meta name="twitter:image" content="https://devonburriss.me/img/explore-590.jpg"><meta property="og:title" content="Testing the Untestable"><meta property="og:type" content="article"><meta property="og:url" content="https://devonburriss.me/testing-the-untestable/"><meta property="og:image" content="https://devonburriss.me/img/explore-590.jpg"><meta property="og:description" content="Testing after the fact testing hurts"><meta property="og:site_name" content="Devon Burriss&#39; Blog"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/clean-blog.css"><link rel="stylesheet" charset="UTF-8" href="/css/highlight/atom-one-light.css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">Devon Burriss&#39; Blog</a></div><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><ul class="nav navbar-nav navbar-right"><li><a href="/">Home</a></li><li><a href="/recommended-reading.html">Recommended Reading</a></li><li><a href="/rss.xml"><span class="fa-stack fa-lg"><i class="fa fa-rss fa-stack-1x"></i></span></a></li></ul></div></div></nav><header class="intro-header" style="background-image: url(&#39;/img/backgrounds/explore-bg.jpg&#39;)"><div class="container-fluid"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="frame"><h1>Testing the Untestable</h1><h2 class="subheading">Testing after the fact testing hurts</h2><span class="meta" itemprop="author" itemscope="" itemtype="https://schema.org/Person">Posted by <span itemprop="name">Devon Burriss</span> on January 27, 2015</span><span style="display:contents"><hr><a href="/topics/engineering-practices/" title="How we build, test, and validate software."><span class="label label-default">Engineering Practices</span></a></span><div></div></div></div></div></div></div></header><article><div class="container-fluid"><div class="row"><div class="col-lg-8"><p>If you have ever tried written unit tests for existing code you know it can be quite challenging. Not only is finding what to test difficult, the code usually just wont be testable. If it is code that you have written and you are at liberty to make some sweeping changes, then you can refactor toward testability. If not I still go through a technique at the end of this article for providing testable classes.</p>
<p><img src="/img/posts/2015/bridge-cables-resize.jpg" alt="bridge cables" /></p>
<!--more-->
<p>Let's first try refactor toward testablility.
Our checklist is as follows:</p>
<ul>
<li>Create integration tests</li>
<li>Apply <a href="http://devonburriss.me/single-respon/">Single Responsibility Principle</a> (SRP)</li>
<li>Apply <a href="http://martinfowler.com/bliki/RoleInterface.html">Role Interfaces</a></li>
<li>Apply Inversion of Control</li>
<li>Last stand - <a href="http://amzn.to/1EN0Ymg">Extract and override</a></li>
</ul>
<blockquote>
<p>NOTE: In the rest of this article I talk about abstractions and usually use interface as an example. A base class is often just as valid as an interface (unless it has multiple roles since the languages I use only allow one inheritence parent). The NB part is that the rest of your application is coded against the abstraction and knows nothing about the implementation class.</p>
</blockquote>
<h2 id="safety-net">Safety net</h2>
<p>Your first step should be to create some high level integration tests. This will at least give you some indication that you have broken something when you do.</p>
<h2 id="what-is-in-a-name">What is in a name?</h2>
<p>A good measure of whether a class adheres to the SRP principle is the name. If the name doesn't exactly describe what it does, or if it contains words like 'manager', 'provider', 'logic', 'handler', it probably does more than one thing. A name should tell you exactly what a class does, and a class can only have one name...
See the SRP link for an example of splitting a class into it's various responsibilities.</p>
<h2 id="role-abstraction">Role abstraction</h2>
<p>A good practice that can be used in conjuction with SRP is adding role interfaces to a class. Hopefully you can refactor to these roles until a class only contains the members in the abstraction but they are a start. Don't be afraid of having classes with a minimal amount of properties and/or methods on it. It means it has a very well defined role.
Even if you do not break a class into multiple classes immediately, if you can refer to them by the role interface you will have far fewer breaks in your code later when you do split it.</p>
<h3 id="example">Example</h3>
<p>{% highlight csharp %}
public class CustomerManager
{
public IEnumerable<Customer> GetAll()</p>
<pre><code>public string GetOrderEmailTemplate()
{
	...
}

public void SendEmail(string template, Customer customer, Order order)
{
	...
}
</code></pre>
<p>}
{% endhighlight %}</p>
<p>Depending on what you prefer you could split this into 2 or 3 interfaces. Definitely a store for retrieving customers and one for email. Better yet would be a 3rd for testability so you can seperate out retrieving email from sending it.</p>
<p>{% highlight csharp %}
public interface CustomerRepository
{
IEnumerable<Customer> GetAll();
}</p>
<p>public interface EmailStore
{
string GetOrderEmailTemplate();
}</p>
<p>public interface EmailService
{
void SendEmail(string template, Customer customer, Order order);
}
{% endhighlight %}</p>
<blockquote>
<p>NOTE: This is just an example. I would usually try refactor this so that sending the email is completely unaware of the domain model.</p>
</blockquote>
<p>Really if you have managed to refactor this far you need just split the classes by abstraction and apply Dependency Injection to invert the dependencies and by then you likely have some easily testable classes.</p>
<h2 id="untestable-i-tell-you">Untestable I tell you!</h2>
<p>Ok so you have looked at the above but to no avail. You have some dependencies in your class that cannot be injected. A very common reason for this is your class has a dependency on a static class that just cannot be refactored right now to an instance. Another reason is that you just cannot make changes to the public API of the class you are testing.</p>
<blockquote>
<p>WARNING: Think long and hard before using static classes. The ease of use  they offer upfront comes at the dear dear price of testability.</p>
</blockquote>
<p>So the trick to testing a class that seems untestable is <a href="http://amzn.to/1EN0Ymg">Extract and Override</a>. The technique is as follows for the untestable Monster class:</p>
<ol>
<li>Create a class <strong>TestableMonster</strong> that inherits from <strong>Monster</strong>.</li>
<li>Now move the class within <strong>Monster</strong> into protected virtual methods.</li>
<li>Now you can override any par of <strong>Monster</strong> you need to to test it.</li>
<li>In your unit test you will test against <strong>TestableMonster</strong> but you will call the base class for the bits you want to test on it and provide faked procedures for the parts you need to test <strong>Moster</strong> in isolation.</li>
</ol>
<p>Ok so we have gone over the technique in theory, lets take a look at an example.</p>
<h3 id="example-1">Example</h3>
<p>Here is the untestable Monster class.
{% highlight csharp %}
public class Monster
{
public void ScareAllTheChildren()
{
var now = DateTime.UtcNow;
IEnumerable<Child> children= DataRepository.GetAllChildrenFrom(now);</p>
<pre><code>	foreach (var child in children)
	{
		ScareService.Scare(child);
	}
}
</code></pre>
<p>}
{% endhighlight %}
Although the actual example code is unlikely, the structure is tragically common. In less than 10 lines of code we have 3 static references. We will come back to the testable class, lets start extracting out the parts that make this class hard to test.
{% highlight csharp %}
public class Monster
{
public void ScareAllTheChildren()
{
DateTime now = GetCurrentUtcDateTime();
IEnumerable<Child> children = GetChildrenWithBedtimeAfter(now);</p>
<pre><code>	foreach (var child in children)
	{
		ScareChild(child);
	}
}

protected virtual void ScareChild(Child child)
{
	ScareService.Scare(child);
}

protected virtual IEnumerable&lt;Child&gt; GetChildrenWithBedtimeAfter(DateTime now)
{
	return DataRepository.GetAllChildrenFrom(now);
}

protected virtual DateTime GetCurrentUtcDateTime()
{
	return DateTime.UtcNow;
}
</code></pre>
<p>}
{% endhighlight %}</p>
<p>As you can see we have made no changes to the external API of the class. The internal changes were done by wrapping the statics in a method call. Not too much there that is likely to break our production code.
So how would we use this?
{% highlight csharp %}
public class TestableMonster : Monster
{
public DateTime TestDateTime { get; set; }
public List<Child> ScaredChildren  { get; set; }</p>
<pre><code>protected override DateTime GetCurrentUtcDateTime()
{
	return TestDateTime;
}

protected override void ScareChild(Child child)
{
	ScaredChildren.Add(child);
	base.ScareChild(child);
}
</code></pre>
<p>}
{% endhighlight %}
The above example just shows a way to have a date that is settable in your test. You could of course override the other method to return a known list of children.
The following test is more an integration test than a unit test, as the data is not faked (unless you sent back a fake db from the method) but it demonstrates the usage.
{% highlight csharp %}
[TestMethod]
public void Scare_With2OutOf3ChildrenAsleep_ScareCalledOn2Children()
{
//Arrange
var db = InitializeNewDatabase();
db.Children.Add(new Child { Name = &quot;Sam&quot;, LastWentToSleep = DateTime.Parse(&quot;2014-01-31 20:00&quot;) });
db.Children.Add(new Child { Name = &quot;Sam&quot;, LastWentToSleep = DateTime.Parse(&quot;2014-01-31 20:30&quot;) });
db.Children.Add(new Child { Name = &quot;Sam&quot;, LastWentToSleep = DateTime.Parse(&quot;2014-01-31 21:30&quot;) });</p>
<pre><code>var sut = new TestableMonster();
sut.TestDateTime = DateTime.Parse(&quot;2014-01-31 20:45&quot;);

//Act
sut.ScareAllTheChildren();

//Assert
Assert.AreEqual(2, sut.ScaredChildren.Count);
</code></pre>
<p>}
{% endhighlight %}</p>
<h2 id="summary">Summary</h2>
<p>So we went through some steps you could take to make your classes more testable. If you find you are testing a lot of static code you might want to look at the paid for version of <a href="http://www.telerik.com/products/mocking.aspx">JustMock</a> or <a href="http://typemock.com/">TypeMock</a> which are the only to frameworks I know of that allow mocking of statics.</p>
<blockquote>
<p>NOTE: A quick note on DateTime. It is a very sneaky static that leaks into code often. Try make it team policy to not use DateTime and instead use something like this suggested by <a href="http://ayende.com/blog/3408/dealing-with-time-in-tests">Ayenda Rahien</a></p>
</blockquote>
<p>Happy testing!</p>
<hr><ul class="pager"><li class="previous"><a href="/developer-quest-variables/" data-toggle="tooltip" data-placement="top" title="Developer Quest II - Variables">&larr; Previous Post</a></li><li class="next"><a href="/installing-ubuntu-on-hyper-v/" data-toggle="tooltip" data-placement="top" title="Installing Ubuntu on Hyper-V">Next Post &rarr;</a></li></ul></div><div class="col-lg-4 widget-column"><ul class="list-inline text-center"><li><a href="/rss.xml"><span class="fa-stack fa-lg"><i class="fa fa-square fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href="/atom.xml"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://twitter.com/DevonBurriss"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href="https://github.com/dburriss"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><span style="display:contents"><h2><i class="glyphicon glyphicon-th-list"></i>  Topics</h2><a class="badge badge-info" href="/topics/software-design/" title="Architecture, design, modeling, and distributed systems."><span class="site-topic">Software Design</span></a><a class="badge badge-info" href="/topics/engineering-practices/" title="How we build, test, and validate software."><span class="site-topic">Engineering Practices</span></a><a class="badge badge-info" href="/topics/platforms-runtime/" title="Runtimes and execution environments (not frameworks)."><span class="site-topic">Platforms &amp; Runtime</span></a><a class="badge badge-info" href="/topics/tooling-automation/" title="Build tooling, CI/CD, editors, and developer automation."><span class="site-topic">Tooling &amp; Automation</span></a><a class="badge badge-info" href="/topics/reliability-observability/" title="Monitoring, metrics, reliability, and failure modes."><span class="site-topic">Reliability &amp; Observability</span></a><a class="badge badge-info" href="/topics/ai-agentic-systems/" title="AI, LLMs, and agentic workflows."><span class="site-topic">AI &amp; Agentic Systems</span></a><a class="badge badge-info" href="/topics/leadership-teams/" title="Human systems around software development."><span class="site-topic">Leadership &amp; Teams</span></a><a class="badge badge-info" href="/topics/notes-reflections/" title="Learning, career, ethics, and life-adjacent thinking."><span class="site-topic">Notes &amp; Reflections</span></a></span></div></div></div><hr></article><span style="display:contents"><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="copyright text-muted">Copyright &#169; <a href="/about.html">Devon Burriss</a> 2026</p></div></div></div></footer><script src="/js/jquery.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/clean-blog.min.js"></script><script src="/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></span><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-45750611-2', 'auto');ga('send', 'pageview');</script><div class="container-fluid"><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'devonburriss';(function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = 'https://devonburriss.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></body></html>